import { useState, useRef, useEffect } from 'react';
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { ArrowLeft, Mic, MicOff, Volume2, VolumeX, Heart, Stethoscope, Play, Pause } from "lucide-react";
import { toast } from "@/hooks/use-toast";

interface VoiceAssistantProps {
  onBack: () => void;
}

const VoiceAssistant = ({ onBack }: VoiceAssistantProps) => {
  const [isListening, setIsListening] = useState(false);
  const [isSpeaking, setIsSpeaking] = useState(false);
  const [selectedLanguage, setSelectedLanguage] = useState('en');
  const [transcript, setTranscript] = useState('');
  const [response, setResponse] = useState('');
  const [volume, setVolume] = useState(1);
  const [speechRate, setSpeechRate] = useState(1);
  const [isVoiceEnabled, setIsVoiceEnabled] = useState(true);
  
  const recognitionRef = useRef<SpeechRecognition | null>(null);
  const synthRef = useRef<SpeechSynthesis | null>(null);
  const currentUtteranceRef = useRef<SpeechSynthesisUtterance | null>(null);

  const languages = [
    { code: 'en', name: 'English', voice: 'en-US' },
    { code: 'hi', name: 'рд╣рд┐рдВрджреА (Hindi)', voice: 'hi-IN' },
    { code: 'te', name: 'р░др▒Жр░▓р▒Бр░Чр▒Б (Telugu)', voice: 'te-IN' },
    { code: 'ta', name: 'родрооро┐ро┤рпН (Tamil)', voice: 'ta-IN' },
    { code: 'bn', name: 'ржмрж╛ржВрж▓рж╛ (Bengali)', voice: 'bn-IN' },
    { code: 'es', name: 'Espa├▒ol (Spanish)', voice: 'es-ES' },
    { code: 'fr', name: 'Fran├зais (French)', voice: 'fr-FR' }
  ];

  useEffect(() => {
    // Initialize speech synthesis
    if (typeof window !== 'undefined' && 'speechSynthesis' in window) {
      synthRef.current = window.speechSynthesis;
    }

    // Initialize speech recognition
    if (typeof window !== 'undefined') {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (SpeechRecognition) {
        recognitionRef.current = new SpeechRecognition();
        recognitionRef.current.continuous = false;
        recognitionRef.current.interimResults = false;
        
        recognitionRef.current.onstart = () => {
          console.log('Speech recognition started');
          setIsListening(true);
        };
        
        recognitionRef.current.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          console.log('Speech recognition result:', transcript);
          setTranscript(transcript);
          handleVoiceInput(transcript);
        };
        
        recognitionRef.current.onerror = (event) => {
          console.error('Speech recognition error:', event.error);
          setIsListening(false);
          toast({
            title: "Voice Error",
            description: "Sorry, I couldn't hear you clearly. Please try again! ЁЯШК",
            variant: "destructive",
          });
        };
        
        recognitionRef.current.onend = () => {
          console.log('Speech recognition ended');
          setIsListening(false);
        };
      }
    }

    // Cleanup function
    return () => {
      if (recognitionRef.current && isListening) {
        recognitionRef.current.stop();
      }
      if (synthRef.current) {
        synthRef.current.cancel();
      }
    };
  }, [selectedLanguage, isListening]);

  const handleVoiceInput = (transcript: string) => {
    const response = getMedicalResponse(transcript, selectedLanguage);
    setResponse(response);
    if (isVoiceEnabled) {
      speakResponse(response);
    }
  };

  const getMedicalResponse = (userInput: string, language: string): string => {
    const lowerInput = userInput.toLowerCase();
    
    // Enhanced responses for children and elderly with medicine recommendations
    const responses = {
      en: {
        fever: "Oh my! ЁЯдТ You have a fever! Let me help you feel better! Your body is like a brave soldier fighting germs! ЁЯж╕тАНтЩАя╕П\n\nHere's what heroes do:\nтАв Rest like a sleeping superhero ЁЯШ┤\nтАв Drink water like it's your super power! ЁЯТз\nтАв Put a cool cloth on your forehead тЭДя╕П\n\nЁЯТК Medicine that might help (ONLY with doctor's permission!):\nтАв Paracetamol/Acetaminophen for adults\nтАв Children's Tylenol for kids (ask parents first!)\nтАв Ibuprofen for adults only\n\nтЪая╕П SUPER IMPORTANT: You're so brave! But always tell a grown-up and ask a doctor before taking ANY medicine! Call doctor if fever is over 102┬░F! ЁЯдЧ",
        headache: "Ouch! ЁЯШФ Your head hurts! Let's make it feel better together! ЁЯМЯ\n\nTry these magical remedies:\nтАв Rest in a quiet, cozy place ЁЯПа\nтАв Drink water slowly - your brain loves water! ЁЯзаЁЯТз\nтАв Breathe deeply like you're smelling beautiful flowers ЁЯМ╕\nтАв Ask someone to gently massage your temples ЁЯСР\n\nЁЯТК Medicine that might help (ONLY with doctor's permission!):\nтАв Paracetamol/Acetaminophen for mild headaches\nтАв Ibuprofen for adults (not for children under 12)\nтАв NEVER give aspirin to children!\n\nтЪая╕П SUPER IMPORTANT: Ask a grown-up and doctor before taking ANY medicine! Get help if headache is very bad! Remember, you're stronger than any headache! ЁЯТк",
        cough: "Cough, cough! ЁЯШ╖ Don't worry, coughing is your body's way of cleaning itself! ЁЯМкя╕П\n\nLet's help your throat feel better:\nтАв Drink warm honey water (nature's candy!) ЁЯНп\nтАв Breathe steam from a warm shower ЁЯЪ┐\nтАв Rest your voice like it's sleeping ЁЯШ┤\nтАв Gargle with warm salt water if you're old enough ЁЯзВ\n\nЁЯТК Medicine that might help (ONLY with doctor's permission!):\nтАв Cough syrup for persistent cough\nтАв Throat lozenges for older kids/adults\nтАв Honey-based remedies (for kids over 1 year)\n\nтЪая╕П SUPER IMPORTANT: Always ask a grown-up and doctor before taking ANY medicine! Most coughs get better on their own. You'll feel better soon, I promise! ЁЯМИ",
        default: "Hello there, brave friend! ЁЯШК I'm here to help you feel better! ЁЯдЧ\n\nTo give you the best help, can you tell me:\nтАв What part of your body doesn't feel good? ЁЯд╖тАНтЩАя╕П\nтАв When did you start feeling this way? тП░\nтАв What makes it feel better or worse? ЁЯдФ\n\nЁЯТб Remember: I can suggest medicines, but you must ALWAYS tell a grown-up you trust and ask a doctor before taking ANY medicine! Never take medicine alone! ЁЯСитАНтЪХя╕ПЁЯСйтАНтЪХя╕П\n\nRemember, you're very brave for asking about your health! ЁЯж╕тАНтЩВя╕П"
      },
      hi: {
        fever: "рдЕрд░реЗ рд╡рд╛рд╣! ЁЯдТ рдЖрдкрдХреЛ рдмреБрдЦрд╛рд░ рд╣реИ! рдореИрдВ рдЖрдкрдХреЛ рдмреЗрд╣рддрд░ рдорд╣рд╕реВрд╕ рдХрд░рд╛рдиреЗ рдореЗрдВ рдорджрдж рдХрд░реВрдВрдЧрд╛! ЁЯж╕тАНтЩАя╕П\n\nЁЯТК рджрд╡рд╛рдЗрдпрд╛рдБ рдЬреЛ рдорджрдж рдХрд░ рд╕рдХрддреА рд╣реИрдВ (рдХреЗрд╡рд▓ рдбреЙрдХреНрдЯрд░ рдХреА рдЕрдиреБрдорддрд┐ рд╕реЗ!):\nтАв рдкреИрд░рд╛рд╕рд┐рдЯрд╛рдореЛрд▓ рдмрдбрд╝реЛрдВ рдХреЗ рд▓рд┐рдП\nтАв рдмрдЪреНрдЪреЛрдВ рдХреЗ рд▓рд┐рдП рдмрдЪреНрдЪреЛрдВ рд╡рд╛рд▓реА рджрд╡рд╛\nтАв рдЗрдмреБрдкреНрд░реЛрдлреЗрди рдХреЗрд╡рд▓ рдмрдбрд╝реЛрдВ рдХреЗ рд▓рд┐рдП\n\nтЪая╕П рдмрд╣реБрдд рдорд╣рддреНрд╡рдкреВрд░реНрдг: рдЖрдк рдмрд╣реБрдд рдмрд╣рд╛рджреБрд░ рд╣реИрдВ! рдкрд░ рдХреЛрдИ рднреА рджрд╡рд╛ рд▓реЗрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рд╣рдореЗрд╢рд╛ рдмрдбрд╝реЛрдВ рдФрд░ рдбреЙрдХреНрдЯрд░ рд╕реЗ рдкреВрдЫреЗрдВ! ЁЯдЧ",
        headache: "рдЕрд░реЗ! ЁЯШФ рд╕рд┐рд░ рдореЗрдВ рджрд░реНрдж рд╣реЛ рд░рд╣рд╛ рд╣реИ! ЁЯМЯ\n\nЁЯТК рджрд╡рд╛рдЗрдпрд╛рдБ рдЬреЛ рдорджрдж рдХрд░ рд╕рдХрддреА рд╣реИрдВ (рдХреЗрд╡рд▓ рдбреЙрдХреНрдЯрд░ рдХреА рдЕрдиреБрдорддрд┐ рд╕реЗ!):\nтАв рдкреИрд░рд╛рд╕рд┐рдЯрд╛рдореЛрд▓ рд╣рд▓реНрдХреЗ рд╕рд┐рд░рджрд░реНрдж рдХреЗ рд▓рд┐рдП\nтАв рдЗрдмреБрдкреНрд░реЛрдлреЗрди рдХреЗрд╡рд▓ рдмрдбрд╝реЛрдВ рдХреЗ рд▓рд┐рдП\n\nтЪая╕П рдмрд╣реБрдд рдорд╣рддреНрд╡рдкреВрд░реНрдг: рджрд╡рд╛ рд▓реЗрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдмрдбрд╝реЛрдВ рдФрд░ рдбреЙрдХреНрдЯрд░ рд╕реЗ рдкреВрдЫреЗрдВ! рдпрд╛рдж рд░рдЦреЗрдВ, рдЖрдк рдХрд┐рд╕реА рднреА рд╕рд┐рд░рджрд░реНрдж рд╕реЗ рдЬреНрдпрд╛рджрд╛ рдордЬрдмреВрдд рд╣реИрдВ! ЁЯТк",
        cough: "рдЦрд╛рдВрд╕реА рдЖ рд░рд╣реА рд╣реИ! ЁЯШ╖ ЁЯМкя╕П\n\nЁЯТК рджрд╡рд╛рдЗрдпрд╛рдБ рдЬреЛ рдорджрдж рдХрд░ рд╕рдХрддреА рд╣реИрдВ (рдХреЗрд╡рд▓ рдбреЙрдХреНрдЯрд░ рдХреА рдЕрдиреБрдорддрд┐ рд╕реЗ!):\nтАв рдЦрд╛рдВрд╕реА рдХреА рджрд╡рд╛\nтАв рдЧрд▓реЗ рдХреА рдЧреЛрд▓рд┐рдпрд╛рдБ рдмрдбрд╝реЗ рдмрдЪреНрдЪреЛрдВ/рдмрдбрд╝реЛрдВ рдХреЗ рд▓рд┐рдП\nтАв рд╢рд╣рдж рд╡рд╛рд▓реА рджрд╡рд╛ (1 рд╕рд╛рд▓ рд╕реЗ рдмрдбрд╝реЗ рдмрдЪреНрдЪреЛрдВ рдХреЗ рд▓рд┐рдП)\n\nтЪая╕П рдмрд╣реБрдд рдорд╣рддреНрд╡рдкреВрд░реНрдг: рдХреЛрдИ рднреА рджрд╡рд╛ рд▓реЗрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдмрдбрд╝реЛрдВ рдФрд░ рдбреЙрдХреНрдЯрд░ рд╕реЗ рдкреВрдЫреЗрдВ! рдЬрд▓реНрджреА рдареАрдХ рд╣реЛ рдЬрд╛рдПрдВрдЧреЗ! ЁЯМИ",
        default: "рдирдорд╕реНрддреЗ рдмрд╣рд╛рджреБрд░ рджреЛрд╕реНрдд! ЁЯШК ЁЯТб р░Чр▒Бр░░р▒Нр░др▒Бр░Вр░Ър▒Бр░Хр▒Лр░Вр░бр░┐: р░ир▒Зр░ир▒Б р░ор░Вр░жр▒Бр░▓р░ир▒Б р░╕р▒Вр░Ър░┐р░Вр░Ър░Чр░▓р░ир▒Б, р░Хр░╛р░ир▒А р░Пр░жр▒Ир░ир░╛ р░ор░Вр░жр▒Б р░др▒Ар░╕р▒Бр░Хр▒Бр░ир▒З р░ор▒Бр░Вр░жр▒Б р░Ор░▓р▒Нр░▓р░кр▒Нр░кр▒Бр░бр▒В р░кр▒Жр░жр▒Нр░жр░▓р░ир░┐ р░ор░░р░┐р░пр▒Б р░бр░╛р░Хр▒Нр░Яр░░р▒НтАМр░ир░┐ р░Ер░бр░Чр░╛р░▓р░┐! ЁЯСитАНтЪХя╕ПЁЯСйтАНтЪХя╕П"
      },
      te: {
        fever: "р░Ер░пр▒Нр░пр▒Л! ЁЯдТ р░ор▒Ар░Хр▒Б р░Ьр▒Нр░╡р░░р░В р░╡р░Ър▒Нр░Ър░┐р░Вр░жр░╛! ЁЯж╕тАНтЩАя╕П\n\nЁЯТК р░╕р░╣р░╛р░пр░кр░бр▒З р░ор░Вр░жр▒Бр░▓р▒Б (р░╡р▒Ир░жр▒Нр░пр▒Бр░ир░┐ р░Ер░ир▒Бр░ор░др░┐р░др▒Л р░ор░╛р░др▒Нр░░р░ор▒З!):\nтАв р░кр▒Жр░░р░╛р░╕р░┐р░Яр░ор░╛р░▓р▒Н р░кр▒Жр░жр▒Нр░жр░▓р░Хр▒Б\nтАв р░кр░┐р░▓р▒Нр░▓р░▓р░Хр▒Б р░кр░┐р░▓р▒Нр░▓р░▓ р░ор░Вр░жр▒Б\n\nтЪая╕П р░Ър░╛р░▓р░╛ р░ор▒Бр░Цр▒Нр░пр░В: р░ор▒Ар░░р▒Б р░Ър░╛р░▓р░╛ р░зр▒Ир░░р▒Нр░пр░╡р░Вр░др▒Бр░▓р▒Б! р░Хр░╛р░ир▒А р░П р░ор░Вр░жр▒Б р░Ер░пр░┐р░ир░╛ р░др▒Ар░╕р▒Бр░Хр▒Бр░ир▒З р░ор▒Бр░Вр░жр▒Б р░кр▒Жр░жр▒Нр░жр░▓р░ир░┐ р░ор░░р░┐р░пр▒Б р░бр░╛р░Хр▒Нр░Яр░░р▒НтАМр░ир░┐ р░Ер░бр░Чр░Вр░бр░┐! ЁЯдЧ",
        headache: "р░Ер░пр▒Нр░пр▒Л! ЁЯШФ р░др░▓ р░ир▒Кр░кр▒Нр░кр░┐р░Чр░╛ р░Йр░Вр░жр░╛! ЁЯМЯ\n\nЁЯТК р░╕р░╣р░╛р░пр░кр░бр▒З р░ор░Вр░жр▒Бр░▓р▒Б (р░╡р▒Ир░жр▒Нр░пр▒Бр░ир░┐ р░Ер░ир▒Бр░ор░др░┐р░др▒Л р░ор░╛р░др▒Нр░░р░ор▒З!):\nтАв р░кр▒Жр░░р░╛р░╕р░┐р░Яр░ор░╛р░▓р▒Н р░др▒Зр░▓р░┐р░Хр░кр░╛р░Яр░┐ р░др░▓р░ир▒Кр░кр▒Нр░кр░┐р░Хр░┐\n\nтЪая╕П р░Ър░╛р░▓р░╛ р░ор▒Бр░Цр▒Нр░пр░В: р░ор░Вр░жр▒Б р░др▒Ар░╕р▒Бр░Хр▒Бр░ир▒З р░ор▒Бр░Вр░жр▒Б р░кр▒Жр░жр▒Нр░жр░▓р░ир░┐ р░ор░░р░┐р░пр▒Б р░бр░╛р░Хр▒Нр░Яр░░р▒НтАМр░ир░┐ р░Ер░бр░Чр░Вр░бр░┐! ЁЯТк",
        cough: "р░жр░Чр▒Н р░Чр▒Бр░ор▒Н! ЁЯШ╖ ЁЯМкя╕П\n\nЁЯТК р░╕р░╣р░╛р░пр░кр░бр▒З р░ор░Вр░жр▒Бр░▓р▒Б (р░╡р▒Ир░жр▒Нр░пр▒Бр░ир░┐ р░Ер░ир▒Бр░ор░др░┐р░др▒Л р░ор░╛р░др▒Нр░░р░ор▒З!):\nтАв р░жр░Чр▒Нр░Чр▒Б р░ор░Вр░жр▒Б\nтАв р░Чр▒Кр░Вр░др▒Б р░оро╛родрпНродро┐ро░рпИроХро│р▒Б р░кр▒Жр░жр▒Нр░жр░▓р░Хр▒Б\n\nтЪая╕П р░Ър░╛р░▓р░╛ р░ор▒Бр░Цр▒Нр░пр░В: р░П р░ор░Вр░жр▒Б р░Ер░пр░┐р░ир░╛ р░др▒Ар░╕р▒Бр░Хр▒Бр░ир▒З р░ор▒Бр░Вр░жр▒Б р░кр▒Жр░жр▒Нр░жр░▓р░ир░┐ р░ор░░р░┐р░пр▒Б р░бр░╛р░Хр▒Нр░Яр░░р▒НтАМр░ир░┐ р░Ер░бр░Чр░Вр░бр░┐! ЁЯМИ",
        default: "р░ир░ор░╕р▒Нр░Хр░╛р░░р░В р░зр▒Ир░░р▒Нр░пр░╡р░Вр░др▒Бр░бр░╛! ЁЯШК ЁЯТб р░Чр▒Бр░░р▒Нр░др▒Бр░Вр░Ър▒Бр░Хр▒Лр░Вр░бр░┐: р░ир▒Зр░ир▒Б р░ор░Вр░жр▒Бр░▓р░ир▒Б р░╕р▒Вр░Ър░┐р░Вр░Ър░Чр░▓р░ир▒Б, р░Хр░╛р░ир▒А р░Пр░жр▒Ир░ир░╛ р░ор░Вр░жр▒Б р░др▒Ар░╕р▒Бр░Хр▒Бр░ир▒З р░ор▒Бр░Вр░жр▒Б р░Ор░▓р▒Нр░▓р░кр▒Нр░кр▒Бр░бр▒В р░кр▒Жр░жр▒Нр░жр░▓р░ир░┐ р░ор░░р░┐р░пр▒Б р░бр░╛р░Хр▒Нр░Яр░░р▒НтАМр░ир░┐ р░Ер░бр░Чр░╛р░▓р░┐! ЁЯСитАНтЪХя╕ПЁЯСйтАНтЪХя╕П"
      },
      ta: {
        fever: "роЕропрпНропрпЛ! ЁЯдТ роЙроЩрпНроХро│рпБроХрпНроХрпБ роХро╛ропрпНроЪрпНроЪро▓рпН ро╡роирпНродрпБро│рпНро│родрпБ! ЁЯж╕тАНтЩАя╕П\n\nЁЯТК роЙродро╡роХрпНроХрпВроЯро┐роп рооро░рпБроирпНродрпБроХро│рпН (рооро░рпБродрпНродрпБро╡ро░рпН роЕройрпБроородро┐ропрпБроЯройрпН роороЯрпНроЯрпБроорпЗ!):\nтАв рокро╛ро░ро╛роЪро┐роЯрпНроЯрооро╛ро▓рпН рокрпЖро░ро┐ропро╡ро░рпНроХро│рпБроХрпНроХрпБ\nтАв роХрпБро┤роирпНродрпИроХро│рпБроХрпНроХрпБ роХрпБро┤роирпНродрпИроХро│рпН рооро░рпБроирпНродрпБ\n\nтЪая╕П рооро┐роХ роорпБроХрпНроХро┐ропроорпН: роирпАроЩрпНроХро│рпН рооро┐роХро╡рпБроорпН родрпИро░ро┐ропрооро╛ройро╡ро░рпН! роЖройро╛ро▓рпН роОроирпНрод рооро░рпБроирпНродрпБроорпН роОроЯрпБроХрпНроХрпБроорпН роорпБройрпН рокрпЖро░ро┐ропро╡ро░рпНроХро│рпН рооро▒рпНро▒рпБроорпН рооро░рпБродрпНродрпБро╡ро░ро┐роЯроорпН роХрпЗро│рпБроЩрпНроХро│рпН! ЁЯдЧ",
        headache: "роЕропрпНропрпЛ! ЁЯШФ родро▓рпИро╡ро▓ро┐ роЗро░рпБроХрпНроХро┐ро▒родро╛! ЁЯМЯ\n\nЁЯТК роЙродро╡роХрпНроХрпВроЯро┐роп рооро░рпБроирпНродрпБроХро│рпН (рооро░рпБродрпНродрпБро╡ро░рпН роЕройрпБроородро┐ропрпБроЯройрпН роороЯрпНроЯрпБроорпЗ!):\nтАв рокро╛ро░ро╛роЪро┐роЯрпНроЯрооро╛ро▓рпН ро▓рпЗроЪро╛рой родро▓рпИро╡ро▓ро┐роХрпНроХрпБ\n\nтЪая╕П рооро┐роХ роорпБроХрпНроХро┐ропроорпН: рооро░рпБроирпНродрпБ роОроЯрпБроХрпНроХрпБроорпН роорпБройрпН рокрпЖро░ро┐ропро╡ро░рпНроХро│рпН рооро▒рпНро▒рпБроорпН рооро░рпБродрпНродрпБро╡ро░ро┐роЯроорпН роХрпЗро│рпБроЩрпНроХро│рпН! ЁЯТк",
        cough: "роЗро░рпБрооро▓рпН! ЁЯШ╖ ЁЯМкя╕П\n\nЁЯТК роЙродро╡роХрпНроХрпВроЯро┐роп рооро░рпБроирпНродрпБроХро│рпН (рооро░рпБродрпНродрпБро╡ро░рпН роЕройрпБроородро┐ропрпБроЯройрпН роороЯрпНроЯрпБроорпЗ!):\nтАв роЗро░рпБрооро▓рпН рооро░рпБроирпНродрпБ\nтАв родрпКрогрпНроЯрпИ рооро╛родрпНродро┐ро░рпИроХро│рпН рокрпЖро░ро┐ропро╡ро░рпНроХро│рпБроХрпНроХрпБ\n\nтЪая╕П рооро┐роХ роорпБроХрпНроХро┐ропроорпН: роОроирпНрод рооро░рпБроирпНродрпБроорпН роОроЯрпБроХрпНроХрпБроорпН роорпБройрпН рокрпЖро░ро┐ропро╡ро░рпНроХро│рпН рооро▒рпНро▒рпБроорпН рооро░рпБродрпНродрпБро╡ро░ро┐роЯроорпН роХрпЗро│рпБроЩрпНроХро│рпН! ЁЯМИ",
        default: "ро╡рогроХрпНроХроорпН родрпИро░ро┐ропрооро╛рой роирогрпНрокро░рпЗ! ЁЯШК ЁЯТб роиро┐ройрпИро╡ро┐ро▓рпН ро╡рпИроХрпНроХро╡рпБроорпН: роиро╛ройрпН рооро░рпБроирпНродрпБроХро│рпИ рокро░ро┐роирпНродрпБро░рпИроХрпНроХ роорпБроЯро┐ропрпБроорпН, роЖройро╛ро▓рпН роОроирпНрод рооро░рпБроирпНродрпБроорпН роОроЯрпБроХрпНроХрпБроорпН роорпБройрпН роОрокрпНрокрпЛродрпБроорпН рокрпЖро░ро┐ропро╡ро░рпНроХро│рпН рооро▒рпНро▒рпБроорпН рооро░рпБродрпНродрпБро╡ро░ро┐роЯроорпН роХрпЗроЯрпНроХ ро╡рпЗрогрпНроЯрпБроорпН! ЁЯСитАНтЪХя╕ПЁЯСйтАНтЪХя╕П"
      },
      bn: {
        fever: "рж╣рж╛ржпрж╝! ЁЯдТ ржЖржкржирж╛рж░ ржЬрзНржмрж░ рж╣ржпрж╝рзЗржЫрзЗ! ЁЯж╕тАНтЩАя╕П\n\nЁЯТК рж╕рж╛рж╣рж╛ржпрзНржпржХрж╛рж░рзА ржУрж╖рзБржз (рж╢рзБржзрзБржорж╛рждрзНрж░ ржбрж╛ржХрзНрждрж╛рж░рзЗрж░ ржЕржирзБржорждрж┐рждрзЗ!):\nтАв ржкрзНржпрж╛рж░рж╛рж╕рж┐ржЯрж╛ржорж▓ ржмржбрж╝ржжрзЗрж░ ржЬржирзНржп\nтАв рж╢рж┐рж╢рзБржжрзЗрж░ ржЬржирзНржп рж╢рж┐рж╢рзБржжрзЗрж░ ржУрж╖рзБржз\n\nтЪая╕П ржЦрзБржмржЗ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг: ржЖржкржирж┐ ржЦрзБржм рж╕рж╛рж╣рж╕рзА! ржХрж┐ржирзНрждрзБ ржХрзЛржирзЛ ржУрж╖рзБржз ржЦрж╛ржУржпрж╝рж╛рж░ ржЖржЧрзЗ рж╕ржмрж╕ржоржпрж╝ ржмржбрж╝ржжрзЗрж░ ржПржмржВ ржбрж╛ржХрзНрждрж╛рж░ржХрзЗ ржЬрж┐ржЬрзНржЮрж╛рж╕рж╛ ржХрж░рзБржи! ЁЯдЧ",
        headache: "ржЖрж╣! ЁЯШФ ржорж╛ржерж╛ржмрзНржпржерж╛ рж╣ржЪрзНржЫрзЗ! ЁЯМЯ\n\nЁЯТК рж╕рж╛рж╣рж╛ржпрзНржпржХрж╛рж░рзА ржУрж╖рзБржз (рж╢рзБржзрзБржорж╛рждрзНрж░ ржбрж╛ржХрзНрждрж╛рж░рзЗрж░ ржЕржирзБржорждрж┐рждрзЗ!):\nтАв ржкрзНржпрж╛рж░рж╛рж╕рж┐ржЯрж╛ржорж▓ рж╣рж╛рж▓ржХрж╛ ржорж╛ржерж╛ржмрзНржпржерж╛рж░ ржЬржирзНржп\n\nтЪая╕П ржЦрзБржмржЗ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг: ржУрж╖рзБржз ржЦрж╛ржУржпрж╝рж╛рж░ ржЖржЧрзЗ ржмржбрж╝ржжрзЗрж░ ржПржмржВ ржбрж╛ржХрзНрждрж╛рж░ржХрзЗ ржЬрж┐ржЬрзНржЮрж╛рж╕рж╛ ржХрж░рзБржи! ЁЯТк",
        cough: "ржХрж╛рж╢рж┐! ЁЯШ╖ ЁЯМкя╕П\n\nЁЯТК рж╕рж╛рж╣рж╛ржпрзНржпржХрж╛рж░рзА ржУрж╖рзБржз (рж╢рзБржзрзБржорж╛рждрзНрж░ ржбрж╛ржХрзНрждрж╛рж░рзЗрж░ ржЕржирзБржорждрж┐рждрзЗ!):\nтАв ржХрж╛рж╢рж┐рж░ ржУрж╖рзБржз\nтАв ржЧрж▓рж╛рж░ ржЯрзНржпрж╛ржмрж▓рзЗржЯ ржмржбрж╝ржжрзЗрж░ ржЬржирзНржп\n\nтЪая╕П ржЦрзБржмржЗ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг: ржХрзЛржирзЛ ржУрж╖рзБржз ржЦрж╛ржУржпрж╝рж╛рж░ ржЖржЧрзЗ ржмржбрж╝ржжрзЗрж░ ржПржмржВ ржбрж╛ржХрзНрждрж╛рж░ржХрзЗ ржЬрж┐ржЬрзНржЮрж╛рж╕рж╛ ржХрж░рзБржи! ЁЯМИ",
        default: "ржиржорж╕рзНржХрж╛рж░ рж╕рж╛рж╣рж╕рзА ржмржирзНржзрзБ! ЁЯШК ЁЯТб ржоржирзЗ рж░рж╛ржЦржмрзЗржи: ржЖржорж┐ ржУрж╖рзБржзрзЗрж░ ржкрж░рж╛ржорж░рзНрж╢ ржжрж┐рждрзЗ ржкрж╛рж░рж┐, рждржмрзЗ ржХрзЛржирзЛ ржУрж╖рзБржз ржЦрж╛ржУржпрж╝рж╛рж░ ржЖржЧрзЗ рж╕ржмрж╕ржоржпрж╝ ржмржбрж╝ржжрзЗрж░ ржПржмржВ ржбрж╛ржХрзНрждрж╛рж░ржХрзЗ ржЬрж┐ржЬрзНржЮрж╛рж╕рж╛ ржХрж░рждрзЗ рж╣ржмрзЗ! ЁЯСитАНтЪХя╕ПЁЯСйтАНтЪХя╕П"
      },
      es: {
        fever: "┬бAy, no! ЁЯдТ ┬бTienes fiebre! ЁЯж╕тАНтЩАя╕П\n\nЁЯТК Medicinas que pueden ayudar (┬бSOLO con permiso del doctor!):\nтАв Paracetamol para adultos\nтАв Medicina para ni├▒os\n\nтЪая╕П MUY IMPORTANTE: ┬бEres muy valiente! ┬бPero siempre pregunta a un adulto y doctor antes de tomar cualquier medicina! ЁЯдЧ",
        headache: "┬бAy! ЁЯШФ ┬бTe duele la cabeza! ЁЯМЯ\n\nЁЯТК Medicinas que pueden ayudar (┬бSOLO con permiso del doctor!):\nтАв Paracetamol para dolores leves\n\nтЪая╕П MUY IMPORTANTE: ┬бPregunta a un adulto y doctor antes de tomar medicina! ЁЯТк",
        cough: "┬бTos! ЁЯШ╖ ЁЯМкя╕П\n\nЁЯТК Medicinas que pueden ayudar (┬бSOLO con permiso del doctor!):\nтАв Jarabe para la tos\nтАв Pastillas para la garganta para adultos\n\nтЪая╕П MUY IMPORTANTE: ┬бPregunta a un adulto y doctor antes de tomar cualquier medicina! ЁЯМИ",
        default: "┬бHola amigo valiente! ЁЯШК ЁЯТб Recuerda: ┬бPuedo sugerir medicinas, pero siempre debes preguntar a un adulto y doctor antes de tomar CUALQUIER medicina! ЁЯСитАНтЪХя╕ПЁЯСйтАНтЪХя╕П"
      },
      fr: {
        fever: "Oh l├а l├а! ЁЯдТ Tu as de la fi├иvre! ЁЯж╕тАНтЩАя╕П\n\nЁЯТК M├йdicaments qui peuvent aider (SEULEMENT avec permission du docteur!):\nтАв Parac├йtamol pour les adultes\nтАв M├йdicament pour enfants\n\nтЪая╕П TR├ИS IMPORTANT: Tu es tr├иs courageux! Mais demande toujours ├а un adulte et docteur avant de prendre des m├йdicaments! ЁЯдЧ",
        headache: "A├пe! ЁЯШФ Tu as mal ├а la t├кte! ЁЯМЯ\n\nЁЯТК M├йdicaments qui peuvent aider (SEULEMENT avec permission du docteur!):\nтАв Parac├йtamol pour les douleurs l├йg├иres\n\nтЪая╕П TR├ИS IMPORTANT: Demande ├а un adulte et docteur avant de prendre des m├йdicaments! ЁЯТк",
        cough: "Toux! ЁЯШ╖ ЁЯМкя╕П\n\nЁЯТК M├йdicaments qui peuvent aider (SEULEMENT avec permission du docteur!):\nтАв Sirop contre la toux\nтАв Pastilles pour la gorge pour adultes\n\nтЪая╕П TR├ИS IMPORTANT: Demande ├а un adulte et docteur avant de prendre des m├йdicaments! ЁЯМИ",
        default: "Bonjour ami courageux! ЁЯШК ЁЯТб Souviens-toi: Je peux sugg├йrer des m├йdicaments, mais tu dois TOUJOURS demander ├а un adulte et docteur avant de prendre des m├йdicaments! ЁЯСитАНтЪХя╕ПЁЯСйтАНтЪХя╕П"
      }
    };

    const languageResponses = responses[language as keyof typeof responses] || responses.en;
    
    if (lowerInput.includes('fever') || lowerInput.includes('рдмреБрдЦрд╛рд░') || lowerInput.includes('р░Ьр▒Нр░╡р░░р░В') || lowerInput.includes('роХро╛ропрпНроЪрпНроЪро▓рпН') || lowerInput.includes('ржЬрзНржмрж░') || lowerInput.includes('fiebre') || lowerInput.includes('fi├иvre')) {
      return languageResponses.fever;
    } else if (lowerInput.includes('headache') || lowerInput.includes('рд╕рд┐рд░рджрд░реНрдж') || lowerInput.includes('р░др░▓р░ир▒Кр░кр▒Нр░кр░┐') || lowerInput.includes('родро▓рпИро╡ро▓ро┐') || lowerInput.includes('ржорж╛ржерж╛ржмрзНржпржерж╛') || lowerInput.includes('dolor de cabeza') || lowerInput.includes('mal de t├кte')) {
      return languageResponses.headache;
    } else if (lowerInput.includes('cough') || lowerInput.includes('рдЦрд╛рдВрд╕реА') || lowerInput.includes('р░жр░Чр▒Нр░Чр▒Б') || lowerInput.includes('роЗро░рпБрооро▓рпН') || lowerInput.includes('ржХрж╛рж╢рж┐') || lowerInput.includes('tos') || lowerInput.includes('toux')) {
      return languageResponses.cough;
    }
    
    return languageResponses.default;
  };

  const speakResponse = (text: string) => {
    if (!synthRef.current || !isVoiceEnabled) return;

    // Cancel any ongoing speech
    synthRef.current.cancel();

    const utterance = new SpeechSynthesisUtterance(text);
    const selectedLang = languages.find(lang => lang.code === selectedLanguage);
    
    utterance.lang = selectedLang?.voice || 'en-US';
    utterance.volume = volume;
    utterance.rate = speechRate;
    utterance.pitch = 1.2; // Slightly higher pitch for friendliness
    
    utterance.onstart = () => {
      setIsSpeaking(true);
    };
    
    utterance.onend = () => {
      setIsSpeaking(false);
      currentUtteranceRef.current = null;
    };
    
    utterance.onerror = (event) => {
      console.error('Speech synthesis error:', event.error);
      setIsSpeaking(false);
      currentUtteranceRef.current = null;
    };

    currentUtteranceRef.current = utterance;
    synthRef.current.speak(utterance);
  };

  const startListening = () => {
    if (!recognitionRef.current) {
      toast({
        title: "Voice Not Supported",
        description: "Sorry, voice recognition is not supported in your browser! ЁЯШЕ",
        variant: "destructive",
      });
      return;
    }

    const selectedLang = languages.find(lang => lang.code === selectedLanguage);
    recognitionRef.current.lang = selectedLang?.voice || 'en-US';
    
    try {
      recognitionRef.current.start();
      toast({
        title: "Listening! ЁЯСВ",
        description: "Speak now! I'm listening to help you! ЁЯШК",
      });
    } catch (error) {
      console.error('Error starting recognition:', error);
      toast({
        title: "Error",
        description: "Couldn't start listening. Please try again! ЁЯШЕ",
        variant: "destructive",
      });
    }
  };

  const stopListening = () => {
    if (recognitionRef.current && isListening) {
      recognitionRef.current.stop();
    }
  };

  const stopSpeaking = () => {
    if (synthRef.current && isSpeaking) {
      synthRef.current.cancel();
      setIsSpeaking(false);
    }
  };

  const toggleVoice = () => {
    setIsVoiceEnabled(!isVoiceEnabled);
    if (!isVoiceEnabled) {
      stopSpeaking();
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 animate-fade-in">
      <div className="container mx-auto px-4 py-6 max-w-4xl">
        {/* Header */}
        <div className="flex items-center justify-between mb-6">
          <Button
            onClick={onBack}
            variant="outline"
            className="flex items-center gap-2 hover:scale-105 transition-transform"
          >
            <ArrowLeft className="h-4 w-4" />
            Back to Home
          </Button>
          <div className="flex items-center gap-2">
            <Select value={selectedLanguage} onValueChange={setSelectedLanguage}>
              <SelectTrigger className="w-48 hover:scale-105 transition-transform">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                {languages.map(lang => (
                  <SelectItem key={lang.code} value={lang.code}>
                    {lang.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
        </div>

        {/* Health Tip Banner */}
        <div className="mb-6 bg-gradient-to-r from-pink-400 to-purple-500 text-white p-4 rounded-lg shadow-lg animate-scale-in">
          <div className="flex items-center gap-2 mb-2">
            <Heart className="h-5 w-5 animate-pulse" />
            <span className="font-bold">ЁЯТЭ Health Tip for Everyone!</span>
          </div>
          <p className="text-sm">Drinking water is like giving your body a big, refreshing hug! Try to drink 8 glasses a day! ЁЯедтЬи</p>
        </div>

        {/* Voice Assistant Interface */}
        <Card className="shadow-2xl hover:shadow-3xl transition-shadow duration-300">
          <CardHeader className="bg-gradient-to-r from-purple-600 to-pink-600 text-white">
            <CardTitle className="flex items-center gap-2 justify-center text-2xl">
              <Stethoscope className="h-6 w-6 animate-pulse" />
              <Heart className="h-5 w-5 text-pink-300 animate-bounce" />
              Voice Assistant - ArogyaMitra
              <Heart className="h-5 w-5 text-pink-300 animate-bounce" />
            </CardTitle>
          </CardHeader>
          
          <CardContent className="p-8 space-y-6">
            {/* Main Voice Controls */}
            <div className="flex flex-col items-center space-y-6">
              <div className="relative">
                <Button
                  onClick={isListening ? stopListening : startListening}
                  disabled={isSpeaking}
                  className={`w-32 h-32 rounded-full text-white font-bold text-lg shadow-2xl hover:shadow-3xl transition-all duration-300 ${
                    isListening 
                      ? 'bg-gradient-to-r from-red-500 to-pink-500 animate-pulse hover:from-red-600 hover:to-pink-600' 
                      : 'bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 hover:scale-110'
                  }`}
                >
                  {isListening ? (
                    <>
                      <MicOff className="h-12 w-12 mb-2" />
                      Stop
                    </>
                  ) : (
                    <>
                      <Mic className="h-12 w-12 mb-2" />
                      Talk to Me!
                    </>
                  )}
                </Button>
                
                {/* Listening Animation */}
                {isListening && (
                  <div className="absolute -inset-4 border-4 border-green-400 rounded-full animate-ping"></div>
                )}
              </div>

              {/* Voice Controls */}
              <div className="flex items-center gap-4">
                <Button
                  onClick={toggleVoice}
                  variant="outline"
                  className="flex items-center gap-2 hover:scale-105 transition-transform"
                >
                  {isVoiceEnabled ? (
                    <>
                      <Volume2 className="h-4 w-4" />
                      Voice On
                    </>
                  ) : (
                    <>
                      <VolumeX className="h-4 w-4" />
                      Voice Off
                    </>
                  )}
                </Button>
                
                {isSpeaking && (
                  <Button
                    onClick={stopSpeaking}
                    variant="outline"
                    className="flex items-center gap-2 hover:scale-105 transition-transform animate-pulse"
                  >
                    <Pause className="h-4 w-4" />
                    Stop Speaking
                  </Button>
                )}
              </div>
            </div>

            {/* Speech Rate and Volume Controls */}
            <div className="grid md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <label className="text-sm font-medium">Speaking Speed: {speechRate}x</label>
                <input
                  type="range"
                  min="0.5"
                  max="2"
                  step="0.1"
                  value={speechRate}
                  onChange={(e) => setSpeechRate(parseFloat(e.target.value))}
                  className="w-full h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer"
                />
              </div>
              
              <div className="space-y-2">
                <label className="text-sm font-medium">Volume: {Math.round(volume * 100)}%</label>
                <input
                  type="range"
                  min="0"
                  max="1"
                  step="0.1"
                  value={volume}
                  onChange={(e) => setVolume(parseFloat(e.target.value))}
                  className="w-full h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer"
                />
              </div>
            </div>

            {/* Transcript Display */}
            {transcript && (
              <div className="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg border-2 border-blue-200 animate-fade-in">
                <h3 className="font-semibold mb-2 flex items-center gap-2">
                  <Mic className="h-4 w-4 text-blue-600" />
                  You said:
                </h3>
                <p className="text-gray-700 italic">"{transcript}"</p>
              </div>
            )}

            {/* Response Display */}
            {response && (
              <div className="bg-gradient-to-r from-green-50 to-pink-50 p-4 rounded-lg border-2 border-green-200 animate-fade-in">
                <h3 className="font-semibold mb-2 flex items-center gap-2">
                  <Heart className="h-4 w-4 text-green-600" />
                  ArogyaMitra says:
                </h3>
                <p className="text-gray-700 whitespace-pre-line leading-relaxed">{response}</p>
              </div>
            )}

            {/* Status Indicators */}
            <div className="flex justify-center gap-4 text-sm">
              {isListening && (
                <div className="flex items-center gap-2 text-green-600 animate-pulse">
                  <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                  Listening...
                </div>
              )}
              {isSpeaking && (
                <div className="flex items-center gap-2 text-blue-600 animate-pulse">
                  <div className="w-2 h-2 bg-blue-500 rounded-full"></div>
                  Speaking...
                </div>
              )}
            </div>

            {/* Instructions */}
            <div className="bg-gradient-to-r from-yellow-50 to-orange-50 p-4 rounded-lg border-2 border-yellow-200">
              <h3 className="font-semibold mb-2 text-center">ЁЯМЯ How to Use Voice Assistant ЁЯМЯ</h3>
              <ul className="space-y-1 text-sm">
                <li>тАв ЁЯОд Click "Talk to Me!" button to start speaking</li>
                <li>тАв ЁЯЧгя╕П Tell me about your symptoms or ask health questions</li>
                <li>тАв ЁЯФК I'll speak back to you in your chosen language</li>
                <li>тАв ЁЯОЫя╕П Adjust speed and volume for your comfort</li>
                <li>тАв ЁЯСитАНтЪХя╕П Always consult a real doctor for serious concerns!</li>
              </ul>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
};

export default VoiceAssistant;
